<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>expl3 isses</title>
  <link rel="stylesheet" href="node_modules/datatables.net-dt/css/dataTables.dataTables.min.css">
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">

  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/datatables.net/js/dataTables.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
</head>

<body>
  <div class="container">
    <h1>expl3 isues</h1>

    <table id="errorTable">
    </table>

    <!-- Button to Open Modal -->
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
      Filter Issues
    </button>

    <p>
      <a href="errors.txt.bz2">Full list of errors (bzip2 compressed)</a>
    </p>

    <p>
    Generated by <a href="https://github.com/Witiko/expltools/">expltools</a>. Report issues at <a href="https://github.com/koppor/errorformat-to-html/issues">errorformat-to-html</a>. This site is hosted using GitHub pages. <a href="https://docs.github.com/en/site-policy/privacy-policies/github-general-privacy-statement#github-privacy-statement">GitHub's General Privacy Statement</a> applies.
    </p>

  </div>

  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filter Issues</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="checkbox-container"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="clearFilter">Clear Filter</button>
          <button type="button" class="btn btn-primary" id="applyFilter">Apply Filter</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      table = $('#errorTable').DataTable({
        stateSave: true,
        ajax: {
          url: 'errors-summarized.json',
          dataSrc: '' // Data is a direct array at the root of the JSON
        },
        columns: [
          { data: 'filename', title: 'Filename' },
          { data: 'errors', title: '# Errors', defaultContent: 0 },
          { data: 'warnings', title: '# Warnings', defaultContent: 0 },
          {
            data: function (row) {
              return row.lines.join(' ');
            },
            searchable: true,
            visible: false
          }
        ],
        columnDefs: [
          {
            targets: 0, // Make filename clickable
            render: function (data, type, row) {
              if (type === 'display') {
                return `<a href="${data}" target="_blank">${data}</a>`;
              }
              return data;
            }
          }
        ]
      });
    });

    $(document).ready(function () {
      $.getJSON('errors-list.json', function (errorsList) {
        let checkboxContainer = $('#checkbox-container');
        errorsList.forEach(error => {
          let checkbox = `
                <div class="form-check">
                    <input class="form-check-input error-filter" type="checkbox" value="${error}" id="error-${error}">
                    <label class="form-check-label" for="error-${error}">
                        ${error}
                    </label>
                </div>
            `;
          checkboxContainer.append(checkbox);
        });
      });
    });

    $('#applyFilter').on('click', function () {
      let selectedErrors = [];

      $('.error-filter:checked').each(function () {
        selectedErrors.push($(this).val());
      });

      // Apply filter to the last column
      table.column(3).search(selectedErrors.join('|'), true, false).draw();

      // Close the modal
      $('#filterModal').modal('hide');
    });

    // Clear filter button
    $('#clearFilter').on('click', function () {
      // Uncheck all checkboxes
      $('.error-filter').prop('checked', false);

      // Clear DataTable filter
      table.column(3).search('').draw();

      // Close modal
      $('#filterModal').modal('hide');
    });

  </script>
</body>

</html>
